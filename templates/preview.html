<!DOCTYPE html>
<html>
<head>
    <title>CSV Preview</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@11.0.1/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@11.0.1/dist/handsontable.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Add jQuery for AJAX -->
</head>
<body class="container py-5">
    <div class="card shadow p-4">
        <h1 class="text-center mb-4">CSV Preview and Edit</h1>
        <input type="text" id="searchField" class="form-control mb-3" placeholder="Search in table...">
        <div id="csvTable" class="mb-3"></div>
        <div class="text-center">
            <button id="saveChanges" class="btn btn-primary me-2">Save Changes</button>
            <button id="insertToDb" class="btn btn-success me-2">Insert to Database</button>
            <a href="/" class="btn btn-secondary">Back</a>
        </div>
        <div id="saveFeedback" class="text-center mt-3" style="display: none;"></div>
    </div>

    <script>
        var data = {{ table_data|tojson }};
        var filename = "{{ filename }}"; // Pass filename from Flask
        var container = document.getElementById('csvTable');
        var hot = Handsontable(container, {
            data: data,
            rowHeaders: true,
            colHeaders: function(col) {
                return String.fromCharCode(65 + col);
            },
            manualColumnResize: true,
            manualRowResize: true,
            stretchH: 'all',
            contextMenu: [
                'row_above', 'row_below', '---------',
                'col_left', 'col_right', '---------',
                'remove_row', 'remove_col', '---------',
                'undo', 'redo', '---------',
                'cut', 'copy', 'paste'
            ],
            height: 'auto',
            minSpareRows: 1,
            minSpareCols: 1,
            licenseKey: 'non-commercial-and-evaluation',
            undo: true,
            fillHandle: true,
            autoWrapRow: true,
            autoWrapCol: true
        });

        // Make headers editable
        hot.updateSettings({
            beforeChange: function(changes, source) {
                if (changes) {
                    changes.forEach(([row, col, oldValue, newValue]) => {
                        if (row === -1) {
                            let headers = hot.getColHeader();
                            headers[col] = newValue;
                            hot.updateSettings({ colHeaders: headers });
                            return false;
                        }
                    });
                }
            }
        });

        // Search functionality
        var searchField = document.getElementById('searchField');
        searchField.addEventListener('keyup', function () {
            var search = hot.getPlugin('search');
            var queryResult = search.query(this.value);
            hot.render();
        });

        // Save Changes
        document.getElementById('saveChanges').addEventListener('click', function() {
            var editedData = hot.getData();
            var headers = hot.getColHeader();
            var payload = {
                filename: filename,
                headers: headers,
                data: editedData
            };

            $.ajax({
                url: '/save_edited_csv',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    var feedback = document.getElementById('saveFeedback');
                    feedback.style.display = 'block';
                    feedback.className = 'text-success';
                    feedback.innerHTML = `Changes saved! <a href="/download_csv/${response.filename}" class="alert-link">Download updated CSV</a>`;
                    setTimeout(() => feedback.style.display = 'none', 5000);
                },
                error: function(xhr, status, error) {
                    var feedback = document.getElementById('saveFeedback');
                    feedback.style.display = 'block';
                    feedback.className = 'text-danger';
                    feedback.innerText = 'Error saving changes: ' + xhr.responseText;
                    setTimeout(() => feedback.style.display = 'none', 3000);
                }
            });
        });

        document.getElementById('insertToDb').addEventListener('click', function() {
            var fullData = hot.getData();
            var headers = fullData[0];  // Take first row as headers
            var editedData = fullData.slice(1);  // Rest is data
            var payload = {
                filename: filename,
                headers: headers,
                data: editedData
            };

            $.ajax({
                url: '/insert_to_database',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    var feedback = document.getElementById('saveFeedback');
                    feedback.style.display = 'block';
                    feedback.className = 'text-success';
                    feedback.innerText = 'Data inserted successfully!';
                    setTimeout(() => feedback.style.display = 'none', 3000);
                },
                error: function(xhr, status, error) {
                    var feedback = document.getElementById('saveFeedback');
                    feedback.style.display = 'block';
                    feedback.className = 'text-danger';
                    feedback.innerText = 'Error inserting data: ' + xhr.responseText;
                    setTimeout(() => feedback.style.display = 'none', 3000);
                }
            });
        });
    </script>
</body>
</html>